"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const express_1 = __importDefault(require("express"));
const { check, validationResult } = require("express-validator");
const writePost = require("../models/writePost");
const writeRouter = express_1.default.Router();
const auth = require('../middlewares/auth');
const Users = require('../models/user');
writeRouter.route('/')
    .get(auth.required, async (req, res, next) => {
    try {
        await writePost.find({})
            .then((writes) => {
            res.statusCode = 200;
            res.setHeader('Content-Type', 'application/json');
            res.json(writes);
        })
            .catch((err) => {
            next(err);
        });
    }
    catch (err) {
        console.error(err.message);
        res.sendStatus(500);
    }
})
    .post(auth.required, async (req, res, next) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }
    try {
        const newPost = new writePost({
            user: req.payload.id,
            description: req.body.description,
            title: req.body.title,
            img: req.body.img,
            time: Date.now(),
        });
        const post = await newPost.save();
        res.json(post);
    }
    catch (err) {
        console.error(err.message);
        res.sendStatus(500);
    }
});
writeRouter.route('/:id')
    .get(auth.required, async (req, res, next) => {
    try {
        await writePost.findById(req.params.id)
            .then((write) => {
            res.statusCode = 200;
            res.setHeader('Content-Type', 'application/json');
            res.json(write);
        })
            .catch((err) => {
            next(err);
        });
    }
    catch (err) {
        console.error(err.message);
        res.sendStatus(500);
    }
})
    .delete(auth.required, async (req, res, next) => {
    try {
        const tuser = await Users.findById(req.payload.id);
        await writePost.findById(req.params.id)
            .then(async (write) => {
            if (write.user == tuser.id) {
                await write.remove();
                res.json({ msg: "Post Removed" });
            }
            else {
                res.json({ msg: "You cannot remove this post" });
            }
        });
    }
    catch (err) {
        console.error(err.message);
        res.sendStatus(500);
    }
})
    .put(auth.required, async (req, res, next) => {
    try {
        const tuser = await Users.findById(req.payload.id);
        await writePost.findById(req.params.id)
            .then(async (write) => {
            if (write.user == tuser.id) {
                await writePost.findByIdAndUpdate(req.params.id, req.body, { useFindAndModify: false });
                res.json({ msg: "Post Updated" });
            }
            else {
                res.json({ msg: "You cannot update this post" });
            }
        });
    }
    catch (err) {
        console.error(err.message);
        res.sendStatus(500);
    }
});
writeRouter.route('/like/:id')
    .put(auth.required, async (req, res, next) => {
    try {
        const tuser = await Users.findById(req.payload.id);
        await writePost.findById(req.params.id)
            .then(async (write) => {
            if (write.likes.filter((like) => like.user.toString() === req.payload.id).length > 0) {
                return res.status(400).json({ msg: "Post already liked" });
            }
            else {
                write.likes.unshift({ user: req.payload.id });
                await (write === null || write === void 0 ? void 0 : write.save());
                res.json({ msg: "post liked" });
            }
        });
    }
    catch (err) {
        console.error(err.message);
        res.sendStatus(500);
    }
});
writeRouter.route('/unlike/:id')
    .put(auth.required, async (req, res, next) => {
    try {
        const tuser = await Users.findById(req.payload.id);
        await writePost.findById(req.params.id)
            .then(async (write) => {
            if (write.likes.filter((like) => like.user.toString() === req.payload.id).length === 0) {
                return res.status(400).json({ msg: "Post has not yet been liked" });
            }
            else {
                const removeIndex = write.likes
                    .map((like) => like.user.toString())
                    .indexOf(req.payload.id);
                write === null || write === void 0 ? void 0 : write.likes.splice(removeIndex, 1);
                await (write === null || write === void 0 ? void 0 : write.save());
                res.json({ msg: "post unliked" });
            }
        });
    }
    catch (err) {
        console.error(err.message);
        res.sendStatus(500);
    }
});
writeRouter.route('/comment/:id')
    .post(auth.required, async (req, res, next) => {
    try {
        const tuser = await Users.findById(req.payload.id);
        await writePost.findById(req.params.id)
            .then(async (write) => {
            const newComment = {
                time: Date.now(),
                text: req.body.text,
                name: tuser === null || tuser === void 0 ? void 0 : tuser.username,
                user: req.payload.id,
            };
            write === null || write === void 0 ? void 0 : write.comments.unshift(newComment);
            await write.save();
            res.json(write.comments);
        });
    }
    catch (err) {
        console.error(err.message);
        res.sendStatus(500);
    }
});
writeRouter.route('/comment/:id/:comment_id')
    .delete(auth.required, async (req, res, next) => {
    try {
        const tuser = await Users.findById(req.payload.id);
        await writePost.findById(req.params.id)
            .then(async (write) => {
            const comment = write === null || write === void 0 ? void 0 : write.comments.find((comment) => comment.id === req.params.comment_id);
            if (!comment) {
                return res.sendStatus(404);
            }
            if (comment.user.toString() !== req.payload.id) {
                return res.sendStatus(401);
            }
            write.comments = write.comments.filter(({ id }) => id !== req.params.comment_id);
            await write.save();
            return res.json({ msg: "comment deleted" });
        });
    }
    catch (err) {
        console.error(err.message);
        res.sendStatus(500);
    }
});
module.exports = writeRouter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid3JpdGVSb3V0ZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvcm91dGVzL3dyaXRlUm91dGVzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsc0RBQThCO0FBRTlCLE1BQU0sRUFBRSxLQUFLLEVBQUUsZ0JBQWdCLEVBQUUsR0FBRyxPQUFPLENBQUMsbUJBQW1CLENBQUMsQ0FBQztBQUVqRSxNQUFNLFNBQVMsR0FBRyxPQUFPLENBQUMscUJBQXFCLENBQUMsQ0FBQztBQUNqRCxNQUFNLFdBQVcsR0FBRyxpQkFBTyxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBRXJDLE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO0FBQzVDLE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0FBRXhDLFdBQVcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDO0tBRXJCLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxFQUFFO0lBQ3pDLElBQUk7UUFDSixNQUFNLFNBQVMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO2FBQ3ZCLElBQUksQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFFO1lBQ2IsR0FBRyxDQUFDLFVBQVUsR0FBQyxHQUFHLENBQUM7WUFDbkIsR0FBRyxDQUFDLFNBQVMsQ0FBQyxjQUFjLEVBQUMsa0JBQWtCLENBQUMsQ0FBQztZQUNqRCxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3JCLENBQUMsQ0FBQzthQUNELEtBQUssQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ1gsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2QsQ0FBQyxDQUFDLENBQUE7S0FDRDtJQUFDLE9BQU0sR0FBRyxFQUFFO1FBQ1QsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsT0FBTyxD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QyxRQUFRLEVBQUUsS0FBSyxHQUFHLENBQUMsT0FBTyxDQUFDLEVBQUUsRUFBRTtnQkFDNUMsT0FBTyxHQUFHLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2FBQzlCO1lBRUQsS0FBSyxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FFbEMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLEtBQUssR0FBRyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQzNDLENBQUM7WUFFRixNQUFNLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUVuQixPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBQyxHQUFHLEVBQUMsaUJBQWlCLEVBQUMsQ0FBQyxDQUFDO1FBQ3pDLENBQUMsQ0FBQyxDQUFBO0tBQ0w7SUFBQyxPQUFNLEdBQUcsRUFBRTtRQUNULE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzNCLEdBQUcsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUM7S0FDdkI7QUFDTCxDQUFDLENBQUMsQ0FBQTtBQUVGLE1BQU0sQ0FBQyxPQUFPLEdBQUcsV0FBVyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGV4cHJlc3MgZnJvbSBcImV4cHJlc3NcIjtcclxuLy9AdHMtaWdub3JlXHJcbmNvbnN0IHsgY2hlY2ssIHZhbGlkYXRpb25SZXN1bHQgfSA9IHJlcXVpcmUoXCJleHByZXNzLXZhbGlkYXRvclwiKTtcclxuXHJcbmNvbnN0IHdyaXRlUG9zdCA9IHJlcXVpcmUoXCIuLi9tb2RlbHMvd3JpdGVQb3N0XCIpO1xyXG5jb25zdCB3cml0ZVJvdXRlciA9IGV4cHJlc3MuUm91dGVyKCk7XHJcblxyXG5jb25zdCBhdXRoID0gcmVxdWlyZSgnLi4vbWlkZGxld2FyZXMvYXV0aCcpO1xyXG5jb25zdCBVc2VycyA9IHJlcXVpcmUoJy4uL21vZGVscy91c2VyJyk7XHJcblxyXG53cml0ZVJvdXRlci5yb3V0ZSgnLycpXHJcbi8vQHRzLWlnbm9yZVxyXG4uZ2V0KGF1dGgucmVxdWlyZWQsIGFzeW5jIChyZXEsIHJlcywgbmV4dCkgPT4ge1xyXG4gICAgdHJ5IHsgXHJcbiAgICBhd2FpdCB3cml0ZVBvc3QuZmluZCh7fSlcclxuICAgIC50aGVuKCh3cml0ZXMpID0+IHtcclxuICAgICAgICByZXMuc3RhdHVzQ29kZT0yMDA7XHJcbiAgICAgICAgcmVzLnNldEhlYWRlcignQ29udGVudC1UeXBlJywnYXBwbGljYXRpb24vanNvbicpO1xyXG4gICAgICAgIHJlcy5qc29uKHdyaXRlcyk7XHJcbiAgICB9KVxyXG4gICAgLmNhdGNoKChlcnIpID0+IHtcclxuICAgICAgICBuZXh0KGVycik7XHJcbiAgICB9KVxyXG4gICAgfSBjYXRjaChlcnIpIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKGVyci5tZXNzYWdlKTtcclxuICAgICAgICByZXMuc2VuZFN0YXR1cyg1MDApO1xyXG4gICAgfVxyXG59KVxyXG4vL0B0cy1pZ25vcmVcclxuLnBvc3QoYXV0aC5yZXF1aXJlZCwgYXN5bmMgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XHJcbiAgICBjb25zdCBlcnJvcnMgPSB2YWxpZGF0aW9uUmVzdWx0KHJlcSk7XHJcbiAgICBpZiAoIWVycm9ycy5pc0VtcHR5KCkpIHtcclxuICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5qc29uKHsgZXJyb3JzOiBlcnJvcnMuYXJyYXkoKSB9KTtcclxuICAgIH1cclxuXHJcbiAgICB0cnkge1xyXG4gICAgICAgIGNvbnN0IG5ld1Bvc3QgPSBuZXcgd3JpdGVQb3N0KHtcclxuICAgICAgICAgICAgLy9AdHMtaWdub3JlXHJcbiAgICAgICAgICAgIHVzZXI6IHJlcS5wYXlsb2FkLmlkLFxyXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogcmVxLmJvZHkuZGVzY3JpcHRpb24sXHJcbiAgICAgICAgICAgIHRpdGxlOiByZXEuYm9keS50aXRsZSxcclxuICAgICAgICAgICAgaW1nOiByZXEuYm9keS5pbWcsXHJcbiAgICAgICAgICAgIHRpbWU6IERhdGUubm93KCksXHJcbiAgICAgICAgfSlcclxuXHJcbiAgICAgICAgY29uc3QgcG9zdCA9IGF3YWl0IG5ld1Bvc3Quc2F2ZSgpO1xyXG4gICAgICAgIHJlcy5qc29uKHBvc3QpO1xyXG4gICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnIubWVzc2FnZSk7XHJcbiAgICAgICAgcmVzLnNlbmRTdGF0dXMoNTAwKTtcclxuICAgIH1cclxufSlcclxuXHJcbndyaXRlUm91dGVyLnJvdXRlKCcvOmlkJylcclxuLy9AdHMtaWdub3JlXHJcbi5nZXQoYXV0aC5yZXF1aXJlZCwgYXN5bmMgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XHJcbiAgICB0cnkgeyBcclxuICAgIGF3YWl0IHdyaXRlUG9zdC5maW5kQnlJZChyZXEucGFyYW1zLmlkKVxyXG4gICAgLnRoZW4oKHdyaXRlKSA9PiB7XHJcbiAgICAgICAgcmVzLnN0YXR1c0NvZGU9MjAwO1xyXG4gICAgICAgIHJlcy5zZXRIZWFkZXIoJ0NvbnRlbnQtVHlwZScsJ2FwcGxpY2F0aW9uL2pzb24nKTtcclxuICAgICAgICByZXMuanNvbih3cml0ZSk7XHJcbiAgICB9KVxyXG4gICAgLmNhdGNoKChlcnIpID0+IHtcclxuICAgICAgICBuZXh0KGVycik7XHJcbiAgICB9KVxyXG4gICAgfSBjYXRjaChlcnIpIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKGVyci5tZXNzYWdlKTtcclxuICAgICAgICByZXMuc2VuZFN0YXR1cyg1MDApO1xyXG4gICAgfVxyXG59KVxyXG4vL0B0cy1pZ25vcmVcclxuLmRlbGV0ZShhdXRoLnJlcXVpcmVkLCBhc3luYyAocmVxLCByZXMsIG5leHQpID0+IHtcclxuICAgIHRyeSB7XHJcbiAgICAvL0B0cy1pZ25vcmVcclxuICAgIGNvbnN0IHR1c2VyID0gYXdhaXQgVXNlcnMuZmluZEJ5SWQocmVxLnBheWxvYWQuaWQpXHJcbiAgICBhd2FpdCB3cml0ZVBvc3QuZmluZEJ5SWQocmVxLnBhcmFtcy5pZClcclxuICAgIC50aGVuKGFzeW5jICh3cml0ZSkgPT4ge1xyXG4gICAgICAgIC8vQHRzLWlnbm9yZVxyXG4gICAgICAgIGlmKHdyaXRlLnVzZXIgPT0gdHVzZXIuaWQpe1xyXG4gICAgICAgICAgICAvL0B0cy1pZ25vcmVcclxuICAgICAgICAgICAgYXdhaXQgd3JpdGUucmVtb3ZlKCk7XHJcbiAgICAgICAgICAgIHJlcy5qc29uKHsgbXNnOiBcIlBvc3QgUmVtb3ZlZFwiIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNle1xyXG4gICAgICAgICAgICByZXMuanNvbih7IG1zZzogXCJZb3UgY2Fubm90IHJlbW92ZSB0aGlzIHBvc3RcIiB9KTtcclxuICAgICAgICB9XHJcbiAgICB9KVxyXG4gICAgfSBjYXRjaChlcnIpIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKGVyci5tZXNzYWdlKTtcclxuICAgICAgICByZXMuc2VuZFN0YXR1cyg1MDApO1xyXG4gICAgfVxyXG59KVxyXG4vL0B0cy1pZ25vcmVcclxuLnB1dChhdXRoLnJlcXVpcmVkLCBhc3luYyAocmVxLCByZXMsIG5leHQpID0+IHtcclxuICAgIHRyeSB7XHJcbiAgICAvL0B0cy1pZ25vcmVcclxuICAgIGNvbnN0IHR1c2VyID0gYXdhaXQgVXNlcnMuZmluZEJ5SWQocmVxLnBheWxvYWQuaWQpXHJcbiAgICBhd2FpdCB3cml0ZVBvc3QuZmluZEJ5SWQocmVxLnBhcmFtcy5pZClcclxuICAgIC8vQHRzLWlnbm9yZVxyXG4gICAgLnRoZW4oYXN5bmMgKHdyaXRlKSA9PiB7XHJcbiAgICAgICAgLy9AdHMtaWdub3JlXHJcbiAgICAgICAgaWYod3JpdGUudXNlciA9PSB0dXNlci5pZCkge1xyXG4gICAgICAgICAgICBhd2FpdCB3cml0ZVBvc3QuZmluZEJ5SWRBbmRVcGRhdGUocmVxLnBhcmFtcy5pZCwgcmVxLmJvZHksIHt1c2VGaW5kQW5kTW9kaWZ5OmZhbHNlfSlcclxuICAgICAgICAgICAgLy9AdHMtaWdub3JlXHJcbiAgICAgICAgICAgIHJlcy5qc29uKHsgbXNnOiBcIlBvc3QgVXBkYXRlZFwiIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgLy9AdHMtaWdub3JlXHJcbiAgICAgICAgICAgIHJlcy5qc29uKHsgbXNnOiBcIllvdSBjYW5ub3QgdXBkYXRlIHRoaXMgcG9zdFwiIH0pO1xyXG4gICAgICAgIH1cclxuICAgIH0pXHJcbiAgICB9IGNhdGNoKGVycikge1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyLm1lc3NhZ2UpO1xyXG4gICAgICAgIHJlcy5zZW5kU3RhdHVzKDUwMCk7XHJcbiAgICB9XHJcbn0pXHJcblxyXG53cml0ZVJvdXRlci5yb3V0ZSgnL2xpa2UvOmlkJylcclxuLy9AdHMtaWdub3JlXHJcbi5wdXQoYXV0aC5yZXF1aXJlZCwgYXN5bmMgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XHJcbiAgICB0cnkge1xyXG4gICAgICAgIC8vQHRzLWlnbm9yZVxyXG4gICAgICAgIGNvbnN0IHR1c2VyID0gYXdhaXQgVXNlcnMuZmluZEJ5SWQocmVxLnBheWxvYWQuaWQpXHJcbiAgICAgICAgYXdhaXQgd3JpdGVQb3N0LmZpbmRCeUlkKHJlcS5wYXJhbXMuaWQpXHJcbiAgICAgICAgLy9AdHMtaWdub3JlXHJcbiAgICAgICAgLnRoZW4oYXN5bmMgKHdyaXRlKSA9PiB7XHJcbiAgICAgICAgICAgIC8vQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICBpZiAod3JpdGUubGlrZXMuZmlsdGVyKChsaWtlKSA9PiBsaWtlLnVzZXIudG9TdHJpbmcoKSA9PT0gcmVxLnBheWxvYWQuaWQpLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7IG1zZzogXCJQb3N0IGFscmVhZHkgbGlrZWRcIiB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIC8vQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICAgICAgd3JpdGUubGlrZXMudW5zaGlmdCh7IHVzZXI6IHJlcS5wYXlsb2FkLmlkIH0pO1xyXG4gICAgICAgICAgICAgICAgYXdhaXQgd3JpdGU/LnNhdmUoKVxyXG4gICAgICAgICAgICAgICAgcmVzLmpzb24oe21zZzogXCJwb3N0IGxpa2VkXCJ9KVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgIH0gY2F0Y2goZXJyKSB7XHJcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnIubWVzc2FnZSk7XHJcbiAgICAgICAgcmVzLnNlbmRTdGF0dXMoNTAwKTtcclxuICAgIH0gXHJcbn0pXHJcblxyXG53cml0ZVJvdXRlci5yb3V0ZSgnL3VubGlrZS86aWQnKVxyXG4vL0B0cy1pZ25vcmVcclxuLnB1dChhdXRoLnJlcXVpcmVkLCBhc3luYyAocmVxLCByZXMsIG5leHQpID0+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgICAgLy9AdHMtaWdub3JlXHJcbiAgICAgICAgY29uc3QgdHVzZXIgPSBhd2FpdCBVc2Vycy5maW5kQnlJZChyZXEucGF5bG9hZC5pZClcclxuICAgICAgICBhd2FpdCB3cml0ZVBvc3QuZmluZEJ5SWQocmVxLnBhcmFtcy5pZClcclxuICAgICAgICAvL0B0cy1pZ25vcmVcclxuICAgICAgICAudGhlbihhc3luYyAod3JpdGUpID0+IHtcclxuICAgICAgICAgICAgLy9AdHMtaWdub3JlXHJcbiAgICAgICAgICAgIGlmICh3cml0ZS5saWtlcy5maWx0ZXIoKGxpa2UpID0+IGxpa2UudXNlci50b1N0cmluZygpID09PSByZXEucGF5bG9hZC5pZCkubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oeyBtc2c6IFwiUG9zdCBoYXMgbm90IHlldCBiZWVuIGxpa2VkXCIgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZXtcclxuICAgICAgICAgICAgICAvL0dldCByZW1vdmUgaW5kZXhcclxuICAgICAgICAgICAgICAvL0B0cy1pZ25vcmVcclxuICAgICAgICAgICAgICBjb25zdCByZW1vdmVJbmRleCA9IHdyaXRlLmxpa2VzXHJcbiAgICAgICAgICAgICAgICAvL0B0cy1pZ25vcmVcclxuICAgICAgICAgICAgICAgIC5tYXAoKGxpa2UpID0+IGxpa2UudXNlci50b1N0cmluZygpKVxyXG4gICAgICAgICAgICAgICAgLy9AdHMtaWdub3JlXHJcbiAgICAgICAgICAgICAgICAuaW5kZXhPZihyZXEucGF5bG9hZC5pZCk7XHJcblxyXG4gICAgICAgICAgICAgIC8vQHRzLWlnbm9yZVxyXG4gICAgICAgICAgICAgIHdyaXRlPy5saWtlcy5zcGxpY2UocmVtb3ZlSW5kZXgsIDEpO1xyXG4gICAgICAgICAgICAgIGF3YWl0IHdyaXRlPy5zYXZlKCk7XHJcbiAgICAgICAgICAgICAgcmVzLmpzb24oe21zZzogXCJwb3N0IHVubGlrZWRcIn0pXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG4gICAgfSBjYXRjaChlcnIpIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKGVyci5tZXNzYWdlKTtcclxuICAgICAgICByZXMuc2VuZFN0YXR1cyg1MDApO1xyXG4gICAgfSBcclxufSlcclxuXHJcbndyaXRlUm91dGVyLnJvdXRlKCcvY29tbWVudC86aWQnKVxyXG4vL0B0cy1pZ25vcmVcclxuLnBvc3QoYXV0aC5yZXF1aXJlZCwgYXN5bmMgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XHJcbiAgICB0cnkge1xyXG4gICAgICAgIC8vQHRzLWlnbm9yZVxyXG4gICAgICAgIGNvbnN0IHR1c2VyID0gYXdhaXQgVXNlcnMuZmluZEJ5SWQocmVxLnBheWxvYWQuaWQpXHJcbiAgICAgICAgYXdhaXQgd3JpdGVQb3N0LmZpbmRCeUlkKHJlcS5wYXJhbXMuaWQpXHJcbiAgICAgICAgLy9AdHMtaWdub3JlXHJcbiAgICAgICAgLnRoZW4oYXN5bmMgKHdyaXRlKSA9PiB7XHJcbiAgICAgICAgY29uc3QgbmV3Q29tbWVudCA9IHtcclxuICAgICAgICAgICAgdGltZTogRGF0ZS5ub3coKSxcclxuICAgICAgICAgICAgdGV4dDogcmVxLmJvZHkudGV4dCxcclxuICAgICAgICAgICAgLy9AdHMtaWdub3JlXHJcbiAgICAgICAgICAgIG5hbWU6IHR1c2VyPy51c2VybmFtZSxcclxuICAgICAgICAgICAgLy9AdHMtaWdub3JlXHJcbiAgICAgICAgICAgIHVzZXI6IHJlcS5wYXlsb2FkLmlkLFxyXG4gICAgICAgICAgfTtcclxuICAgICAgICAgIC8vQHRzLWlnbm9yZVxyXG4gICAgICAgICAgd3JpdGU/LmNvbW1lbnRzLnVuc2hpZnQobmV3Q29tbWVudCk7XHJcbiAgICAgICAgICAvL0B0cy1pZ25vcmVcclxuICAgICAgICAgIGF3YWl0IHdyaXRlLnNhdmUoKTtcclxuICAgICAgICAgIC8vQHRzLWlnbm9yZVxyXG4gICAgICAgICAgcmVzLmpzb24od3JpdGUuY29tbWVudHMpO1xyXG4gICAgICAgIH0pXHJcbiAgICB9IGNhdGNoKGVycikge1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyLm1lc3NhZ2UpO1xyXG4gICAgICAgIHJlcy5zZW5kU3RhdHVzKDUwMCk7XHJcbiAgICB9XHJcbn0pXHJcblxyXG53cml0ZVJvdXRlci5yb3V0ZSgnL2NvbW1lbnQvOmlkLzpjb21tZW50X2lkJylcclxuLy9AdHMtaWdub3JlXHJcbi5kZWxldGUoYXV0aC5yZXF1aXJlZCwgYXN5bmMgKHJlcSwgcmVzLCBuZXh0KSA9PiB7XHJcbiAgICB0cnkge1xyXG4gICAgICAgIC8vQHRzLWlnbm9yZVxyXG4gICAgICAgIGNvbnN0IHR1c2VyID0gYXdhaXQgVXNlcnMuZmluZEJ5SWQocmVxLnBheWxvYWQuaWQpXHJcbiAgICAgICAgYXdhaXQgd3JpdGVQb3N0LmZpbmRCeUlkKHJlcS5wYXJhbXMuaWQpXHJcbiAgICAgICAgLy9AdHMtaWdub3JlXHJcbiAgICAgICAgLnRoZW4oYXN5bmMgKHdyaXRlKSA9PiB7XHJcbiAgICAgICAgLy9AdHMtaWdub3JlXHJcbiAgICAgICAgY29uc3QgY29tbWVudCA9IHdyaXRlPy5jb21tZW50cy5maW5kKFxyXG4gICAgICAgICAgICAvL0B0cy1pZ25vcmVcclxuICAgICAgICAgICAgKGNvbW1lbnQpID0+IGNvbW1lbnQuaWQgPT09IHJlcS5wYXJhbXMuY29tbWVudF9pZFxyXG4gICAgICAgICk7XHJcbiAgICAgICAgLy8gTWFrZSBzdXJlIGNvbW1lbnQgZXhpc3RzXHJcbiAgICAgICAgaWYgKCFjb21tZW50KSB7XHJcbiAgICAgICAgICAgIHJldHVybiByZXMuc2VuZFN0YXR1cyg0MDQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvL0B0cy1pZ25vcmVcclxuICAgICAgICBpZiAoY29tbWVudC51c2VyLnRvU3RyaW5nKCkgIT09IHJlcS5wYXlsb2FkLmlkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiByZXMuc2VuZFN0YXR1cyg0MDEpO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvL0B0cy1pZ25vcmVcclxuICAgICAgICB3cml0ZS5jb21tZW50cyA9IHdyaXRlLmNvbW1lbnRzLmZpbHRlcihcclxuICAgICAgICAgICAgLy9AdHMtaWdub3JlXHJcbiAgICAgICAgICAgICh7IGlkIH0pID0+IGlkICE9PSByZXEucGFyYW1zLmNvbW1lbnRfaWRcclxuICAgICAgICApO1xyXG4gICAgICAgIC8vQHRzLWlnbm9yZVxyXG4gICAgICAgIGF3YWl0IHdyaXRlLnNhdmUoKTtcclxuICAgICAgICAvL0B0cy1pZ25vcmVcclxuICAgICAgICByZXR1cm4gcmVzLmpzb24oe21zZzpcImNvbW1lbnQgZGVsZXRlZFwifSk7XHJcbiAgICAgICAgfSlcclxuICAgIH0gY2F0Y2goZXJyKSB7XHJcbiAgICAgICAgY29uc29sZS5lcnJvcihlcnIubWVzc2FnZSk7XHJcbiAgICAgICAgcmVzLnNlbmRTdGF0dXMoNTAwKTtcclxuICAgIH1cclxufSlcclxuXHJcbm1vZHVsZS5leHBvcnRzID0gd3JpdGVSb3V0ZXI7Il19